name: Sync kenzok8 and other packages

on:
  schedule:
    - cron: '10 */12 * * *'  # æ¯12å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      config_file:
        description: 'é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: '.github/workflows/sync-config.yaml'

permissions:
  contents: write

jobs:
  sync-repositories:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Read sync configuration
        id: config
        run: |
          CONFIG_FILE="${{ github.event.inputs.config_file || '.github/workflows/sync-config.yaml' }}"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "é”™è¯¯: é…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨"
            exit 1
          fi
          echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT
          echo "âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip
          # å®‰è£… Go ç‰ˆæœ¬çš„ yqï¼ˆæ›´ç¨³å®šï¼‰
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          # éªŒè¯å®‰è£…
          yq --version
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Backup current workflows and config
        run: |
          # å¤‡ä»½æ•´ä¸ª .github ç›®å½•
          if [ -d ".github" ]; then
            mkdir -p /tmp/github-backup
            cp -r .github/* /tmp/github-backup/
            echo "âœ… .github ç›®å½•å¤‡ä»½å®Œæˆ"
          fi

      - name: Clean current repository (keep .git and .github)
        run: |
          echo "ğŸ§¹ æ¸…ç†å½“å‰ä»“åº“å†…å®¹..."
          find . -mindepth 1 -maxdepth 1 \
            -not -name '.git' \
            -not -name '.github' \
            -exec rm -rf {} + 2>/dev/null || true
          echo "âœ… ä»“åº“æ¸…ç†å®Œæˆ"

      - name: Sync repositories
        env:
          CONFIG_FILE: ${{ steps.config.outputs.config_file }}
        run: |
          echo "ğŸ“¦ å¼€å§‹åŒæ­¥ä»“åº“..."
          
          # ä½¿ç”¨ yq è§£æ YAML é…ç½®
          repo_count=$(yq '.repositories | length' "$CONFIG_FILE")
          echo "æ‰¾åˆ° $repo_count ä¸ªä»“åº“éœ€è¦åŒæ­¥"
          
          for i in $(seq 0 $((repo_count - 1))); do
            repo_name=$(yq ".repositories[$i].name" "$CONFIG_FILE")
            repo_url=$(yq ".repositories[$i].url" "$CONFIG_FILE")
            repo_branch=$(yq ".repositories[$i].branch // \"main\"" "$CONFIG_FILE")
            repo_type=$(yq ".repositories[$i].type // \"full\"" "$CONFIG_FILE")
            target_dir=$(yq ".repositories[$i].target_dir // \"\"" "$CONFIG_FILE")
            source_path=$(yq ".repositories[$i].source_path // \"\"" "$CONFIG_FILE")
            
            echo "ğŸ”„ åŒæ­¥ä»“åº“: $repo_name ($repo_url@$repo_branch)"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            TEMP_DIR="/tmp/repo_$i"
            mkdir -p "$TEMP_DIR"
            
            # ä¸‹è½½å¹¶è§£å‹ä»“åº“
            if curl -L -f -o "$TEMP_DIR/repo.zip" "$repo_url/archive/refs/heads/$repo_branch.zip"; then
              if unzip -q "$TEMP_DIR/repo.zip" -d "$TEMP_DIR"; then
                # è·å–è§£å‹åçš„ç›®å½•å
                EXTRACTED_DIR=$(find "$TEMP_DIR" -maxdepth 1 -type d -name "*" | grep -v "^$TEMP_DIR$" | head -1)
                
                if [ -n "$EXTRACTED_DIR" ] && [ -d "$EXTRACTED_DIR" ]; then
                  if [ "$repo_type" = "full" ]; then
                    # å®Œæ•´ä»“åº“åŒæ­¥
                    if [ -n "$target_dir" ]; then
                      mkdir -p "$(dirname "$target_dir")"
                      cp -r "$EXTRACTED_DIR" "$target_dir"
                      echo "âœ… å®Œæ•´ä»“åº“åŒæ­¥åˆ°: $target_dir"
                    else
                      cp -r "$EXTRACTED_DIR"/* ./
                      echo "âœ… å®Œæ•´ä»“åº“åŒæ­¥åˆ°æ ¹ç›®å½•"
                    fi
                  elif [ "$repo_type" = "partial" ] && [ -n "$source_path" ]; then
                    # éƒ¨åˆ†æ–‡ä»¶å¤¹åŒæ­¥
                    if [ -d "$EXTRACTED_DIR/$source_path" ]; then
                      mkdir -p "$target_dir"
                      cp -r "$EXTRACTED_DIR/$source_path"/* "$target_dir"/
                      echo "âœ… éƒ¨åˆ†åŒæ­¥: $source_path -> $target_dir"
                    else
                      echo "âš ï¸ æºè·¯å¾„ä¸å­˜åœ¨: $EXTRACTED_DIR/$source_path"
                    fi
                  else
                    echo "âš ï¸ æœªçŸ¥çš„åŒæ­¥ç±»å‹æˆ–ç¼ºå°‘å‚æ•°: type=$repo_type, source_path=$source_path"
                  fi
                else
                  echo "âŒ æ— æ³•æ‰¾åˆ°è§£å‹åçš„ç›®å½•"
                fi
              else
                echo "âŒ è§£å‹å¤±è´¥: $TEMP_DIR/repo.zip"
              fi
            else
              echo "âŒ ä¸‹è½½å¤±è´¥: $repo_url/archive/refs/heads/$repo_branch.zip"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf "$TEMP_DIR"
          done

          echo "ğŸ‰ æ‰€æœ‰ä»“åº“åŒæ­¥å®Œæˆ"

      - name: Restore workflows and config
        run: |
          if [ -d "/tmp/github-backup" ]; then
            # æ¢å¤æ•´ä¸ª .github ç›®å½•
            mkdir -p .github
            cp -r /tmp/github-backup/* .github/
            echo "âœ… .github ç›®å½•æ¢å¤å®Œæˆ"
          fi

      - name: Apply file replacements
        env:
          CONFIG_FILE: ${{ steps.config.outputs.config_file }}
        run: |
          echo "ğŸ”„ å¼€å§‹åº”ç”¨æ–‡ä»¶æ›¿æ¢..."
          
          replacement_count=$(yq '.file_replacements | length' "$CONFIG_FILE")
          echo "æ‰¾åˆ° $replacement_count ä¸ªæ–‡ä»¶éœ€è¦æ›¿æ¢"
          
          for i in $(seq 0 $((replacement_count - 1))); do
            replacement_name=$(yq ".file_replacements[$i].name" "$CONFIG_FILE")
            source_url=$(yq ".file_replacements[$i].source_url" "$CONFIG_FILE")
            target_path=$(yq ".file_replacements[$i].target_path" "$CONFIG_FILE")
            
            echo "ğŸ“„ æ›¿æ¢æ–‡ä»¶: $replacement_name -> $target_path"
            mkdir -p "$(dirname "$target_path")"
            if curl -f -L -o "$target_path" "$source_url"; then
              echo "âœ… æ›¿æ¢æˆåŠŸ: $target_path"
            else
              echo "âŒ æ›¿æ¢å¤±è´¥: $target_path"
            fi
          done

          echo "ğŸ‰ æ–‡ä»¶æ›¿æ¢å®Œæˆ"

      - name: Commit and push changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          else
            git commit -m "Auto-sync: $(date +'%Y-%m-%d %H:%M:%S') - Multi-repository sync"
            git push origin main
            echo "âœ… æ›´æ”¹å·²æ¨é€"
          fi
