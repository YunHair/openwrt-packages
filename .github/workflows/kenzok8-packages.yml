name: Sync kenzok8 Packages

on:
  schedule:
    - cron: '10 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-kenzok8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install deps
        run: pip install toml

      - name: Backup workflows
        run: |
          mkdir -p /tmp/backup
          cp -r .github/workflows /tmp/backup/
          echo "Workflows backed up"

      - name: Clean repo (keep workflows)
        run: |
          # åˆ é™¤é™¤ .git å’Œ .github å¤–çš„æ‰€æœ‰å†…å®¹
          find . -maxdepth 1 -not -name '.git' -not -name '.github' -exec rm -rf {} + 2>/dev/null || true
          echo "Repository cleaned"

      - name: Sync repositories
        run: |
          python3 << 'EOF'
          import toml, os, subprocess, tempfile, shutil
          
          config = toml.load('.github/workflows/sync-config.toml')
          
          for repo in config['repositories']:
              print(f"ğŸ”„ Syncing {repo['name']}...")
              
              with tempfile.TemporaryDirectory() as tmpdir:
                  # ä¸‹è½½ä»“åº“
                  zip_url = f"{repo['url']}/archive/refs/heads/{repo.get('branch', 'main')}.zip"
                  zip_file = os.path.join(tmpdir, "repo.zip")
                  
                  subprocess.run(['curl', '-sL', '-o', zip_file, zip_url], check=True)
                  subprocess.run(['unzip', '-q', zip_file, '-d', tmpdir], check=True)
                  
                  # æ‰¾åˆ°è§£å‹ç›®å½•
                  extracted = [d for d in os.listdir(tmpdir) 
                             if os.path.isdir(os.path.join(tmpdir, d)) and not d.startswith('__')][0]
                  src_dir = os.path.join(tmpdir, extracted)
                  
                  if repo.get('type') == 'partial':
                      # éƒ¨åˆ†åŒæ­¥
                      src_path = os.path.join(src_dir, repo['source_path'])
                      target_dir = repo['target_dir']
                      if os.path.exists(src_path):
                          os.makedirs(target_dir, exist_ok=True)
                          # æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                          if os.path.exists(target_dir):
                              shutil.rmtree(target_dir)
                          shutil.copytree(src_path, target_dir)
                          print(f"âœ… Partial sync: {repo['source_path']} -> {target_dir}")
                      else:
                          print(f"âŒ Source path not found: {src_path}")
                  else:
                      # å®Œæ•´åŒæ­¥
                      target_dir = repo.get('target_dir', '.')
                      if target_dir and target_dir != '.':
                          os.makedirs(target_dir, exist_ok=True)
                          # æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                          if os.path.exists(target_dir):
                              shutil.rmtree(target_dir)
                          shutil.copytree(src_dir, target_dir)
                          print(f"âœ… Full sync to: {target_dir}")
                      else:
                          # åŒæ­¥åˆ°æ ¹ç›®å½•
                          for item in os.listdir(src_dir):
                              src_item = os.path.join(src_dir, item)
                              dst_item = os.path.join('.', item)
                              if os.path.isdir(src_item):
                                  if os.path.exists(dst_item):
                                      shutil.rmtree(dst_item)
                                  shutil.copytree(src_item, dst_item)
                              else:
                                  shutil.copy2(src_item, dst_item)
                          print("âœ… Full sync to root")
          
          print("ğŸ‰ All repositories synced!")
          EOF

      - name: Restore workflows
        run: |
          if [ -d "/tmp/backup/workflows" ]; then
            mkdir -p .github/workflows
            cp -r /tmp/backup/workflows/* .github/workflows/
            echo "âœ… Workflows restored"
          fi

      - name: Replace files
        run: |
          python3 << 'EOF'
          import toml, urllib.request, os
          
          config = toml.load('.github/workflows/sync-config.toml')
          
          for file in config.get('file_replacements', []):
              os.makedirs(os.path.dirname(file['target_path']), exist_ok=True)
              urllib.request.urlretrieve(file['source_url'], file['target_path'])
              print(f"ğŸ“„ Replaced {file['target_path']}")
          
          print("âœ… File replacements completed")
          EOF

      - name: Commit and push
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            git commit -m "Auto-sync: $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Changes pushed"
          fi

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.REPO_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 3
