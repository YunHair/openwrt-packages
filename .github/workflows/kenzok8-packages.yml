name: Sync kenzok8 and other packages

on:
  schedule:
    - cron: '10 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install deps
        run: pip install toml

      - name: Backup workflows
        run: |
          mkdir -p /tmp/backup
          cp -r .github/workflows /tmp/backup/
          echo "Workflows backed up"

      - name: Clean repo (keep workflows)
        run: |
          # Âà†Èô§Èô§ .git Âíå .github Â§ñÁöÑÊâÄÊúâÂÜÖÂÆπ
          find . -maxdepth 1 -not -name '.git' -not -name '.github' -exec rm -rf {} + 2>/dev/null || true
          echo "Repository cleaned"

      - name: Sync repositories
        run: |
          python3 << 'EOF'
          import toml, os, subprocess, tempfile, shutil
          
          config = toml.load('.github/workflows/sync-config.toml')
          
          for repo in config['repositories']:
              print(f"üîÑ Syncing {repo['name']}...")
              
              with tempfile.TemporaryDirectory() as tmpdir:
                  # ‰∏ãËΩΩ‰ªìÂ∫ì
                  zip_url = f"{repo['url']}/archive/refs/heads/{repo.get('branch', 'main')}.zip"
                  zip_file = os.path.join(tmpdir, "repo.zip")
                  
                  subprocess.run(['curl', '-sL', '-o', zip_file, zip_url], check=True)
                  subprocess.run(['unzip', '-q', zip_file, '-d', tmpdir], check=True)
                  
                  # ÊâæÂà∞Ëß£ÂéãÁõÆÂΩï
                  extracted = [d for d in os.listdir(tmpdir) 
                             if os.path.isdir(os.path.join(tmpdir, d)) and not d.startswith('__')][0]
                  src_dir = os.path.join(tmpdir, extracted)
                  
                  if repo.get('type') == 'partial':
                      # ÈÉ®ÂàÜÂêåÊ≠•
                      src_path = os.path.join(src_dir, repo['source_path'])
                      if os.path.exists(src_path):
                          shutil.copytree(src_path, repo['target_dir'], dirs_exist_ok=True)
                          print(f"‚úÖ Partial sync: {repo['source_path']} -> {repo['target_dir']}")
                      else:
                          print(f"‚ùå Source path not found: {src_path}")
                  else:
                      # ÂÆåÊï¥ÂêåÊ≠•
                      target = repo.get('target_dir', '.')
                      if target != '.':
                          shutil.copytree(src_dir, target, dirs_exist_ok=True)
                          print(f"‚úÖ Full sync to: {target}")
                      else:
                          for item in os.listdir(src_dir):
                              src_item = os.path.join(src_dir, item)
                              dst_item = os.path.join('.', item)
                              if os.path.isdir(src_item):
                                  shutil.copytree(src_item, dst_item, dirs_exist_ok=True)
                              else:
                                  shutil.copy2(src_item, dst_item)
                          print("‚úÖ Full sync to root")
          
          print("üéâ All repositories synced!")
          EOF

      - name: Restore workflows
        run: |
          if [ -d "/tmp/backup/workflows" ]; then
            mkdir -p .github/workflows
            cp -r /tmp/backup/workflows/* .github/workflows/
            echo "‚úÖ Workflows restored"
          fi

      - name: Replace files
        run: |
          python3 << 'EOF'
          import toml, urllib.request, os
          
          config = toml.load('.github/workflows/sync-config.toml')
          
          for file in config.get('file_replacements', []):
              os.makedirs(os.path.dirname(file['target_path']), exist_ok=True)
              urllib.request.urlretrieve(file['source_url'], file['target_path'])
              print(f"üìÑ Replaced {file['target_path']}")
          
          print("‚úÖ File replacements completed")
          EOF

      - name: Commit and push
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "üìù No changes to commit"
          else
            git commit -m "Auto-sync: $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "‚úÖ Changes pushed"
          fi
